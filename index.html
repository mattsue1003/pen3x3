
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3x3 運筆練習產生器 - 鍾孟修 職能治療師</title>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .a4-page {
            width: 210mm;
            height: 297mm;
            min-width: 210mm;
            min-height: 297mm;
            box-sizing: border-box;
            background-color: white;
            margin: 0 auto;
        }

        @media screen and (max-width: 210mm) {
            .a4-page {
                width: 95vw;
                height: 134.3vw;
                margin-bottom: 2rem;
            }
        }

        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            body {
                background: white !important;
                margin: 0;
                padding: 0;
            }
            .no-print {
                display: none !important;
            }
            .a4-page {
                width: 210mm;
                height: 297mm;
                margin: 0;
                page-break-after: always;
                box-shadow: none !important;
                border: none !important;
            }
            .a4-page:last-child {
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- Constants ---
        const DOT_SPACING = 40; 
        const PADDING = 15;
        const GRID_SIZE = 3;
        const ITEMS_PER_PAGE = 6;

        // --- Utils ---
        const generateRandomPattern = (segmentsCount = 4) => {
            const points = [];
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    points.push({ x: i, y: j });
                }
            }

            const path = [];
            let current = points[Math.floor(Math.random() * points.length)];
            path.push(current);

            const used = new Set([`${current.x},${current.y}`]);

            for (let i = 0; i < segmentsCount; i++) {
                const neighbors = [];
                for (let dx = -1; dx <= 1; dx++) {
                    for (let dy = -1; dy <= 1; dy++) {
                        if (dx === 0 && dy === 0) continue;
                        const nx = current.x + dx;
                        const ny = current.y + dy;
                        if (nx >= 0 && nx < GRID_SIZE && ny >= 0 && ny < GRID_SIZE && !used.has(`${nx},${ny}`)) {
                            neighbors.push({ x: nx, y: ny });
                        }
                    }
                }

                if (neighbors.length === 0) break;
                const next = neighbors[Math.floor(Math.random() * neighbors.length)];
                path.push(next);
                used.add(`${next.x},${next.y}`);
                current = next;
            }
            return path;
        };

        // --- Components ---
        const DotGrid = ({ path = [], showPath = true }) => {
            const dots = [];
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    dots.push({ x, y });
                }
            }

            const viewBoxSize = (GRID_SIZE - 1) * DOT_SPACING + PADDING * 2;

            return (
                <svg 
                    viewBox={`0 0 ${viewBoxSize} ${viewBoxSize}`} 
                    className="w-full h-auto"
                    style={{ maxWidth: '120px', maxHeight: '120px' }}
                >
                    {showPath && path.length > 1 && (
                        <polyline
                            points={path.map(p => `${p.x * DOT_SPACING + PADDING},${p.y * DOT_SPACING + PADDING}`).join(' ')}
                            fill="none"
                            stroke="#000000"
                            strokeWidth="5"
                            strokeLinecap="round"
                            strokeLinejoin="round"
                        />
                    )}
                    {dots.map((dot, i) => (
                        <circle
                            key={i}
                            cx={dot.x * DOT_SPACING + PADDING}
                            cy={dot.y * DOT_SPACING + PADDING}
                            r="5"
                            className="fill-slate-400"
                        />
                    ))}
                </svg>
            );
        };

        const ExerciseCard = ({ path }) => (
            <div className="flex flex-col items-center border-2 border-slate-100 p-4 rounded-xl bg-white shadow-sm h-full justify-between">
                <div className="w-full text-center">
                    <div className="text-sm font-black text-slate-700 mb-2">【看這題】</div>
                    <div className="flex justify-center border-b-2 border-dashed border-slate-50 pb-4 mb-4">
                       <DotGrid path={path} showPath={true} />
                    </div>
                </div>
                <div className="w-full text-center">
                    <div className="text-sm font-black text-slate-700 mb-2">【照著畫】</div>
                    <div className="flex justify-center">
                        <DotGrid path={path} showPath={false} />
                    </div>
                </div>
            </div>
        );

        const PageHeader = () => (
            <div className="border-b-4 border-slate-900 pb-4 mb-4 flex justify-between items-end">
                <div>
                    <h2 className="text-3xl font-black text-slate-900 tracking-tight">運筆練習：3x3 連線卷</h2>
                    <p className="text-slate-500 text-sm font-bold mt-1">請看上方圖案，並在下方點點中畫出一樣的線條。</p>
                </div>
                <div className="text-right text-base font-black text-slate-700 space-y-1">
                    <div>日期：20____ / ____ / ____</div>
                    <div>姓名：________________</div>
                </div>
            </div>
        );

        const FooterInfo = () => (
            <div className="mt-4 pt-4 border-t border-slate-100 flex flex-col gap-2 text-xs font-bold text-slate-400">
                <div className="flex justify-between items-center">
                    <div>
                        設計者：
                        <a href="https://www.facebook.com/profile.php?id=100063748491881" target="_blank" className="text-blue-500 hover:underline">
                            鍾孟修 職能治療師
                        </a>
                    </div>
                    <div>3x3 空間感知訓練 • 寬鬆佈局版</div>
                </div>
                <div>
                    個人新書：
                    <a href="https://www.books.com.tw/products/0011022363?sloc=main" target="_blank" className="text-orange-500 hover:underline">
                        讓你健康不失智的體智能
                    </a>
                </div>
            </div>
        );

        // --- Main App ---
        function App() {
            const [pagesCount, setPagesCount] = useState(1);
            const [complexity, setComplexity] = useState(4);
            const [allPagesData, setAllPagesData] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            const containerRef = useRef(null);

            const generateData = useCallback(() => {
                const totalItems = pagesCount * ITEMS_PER_PAGE;
                const items = Array.from({ length: totalItems }, () => generateRandomPattern(complexity));
                const pages = [];
                for (let i = 0; i < items.length; i += ITEMS_PER_PAGE) {
                    pages.push(items.slice(i, i + ITEMS_PER_PAGE));
                }
                setAllPagesData(pages);
            }, [pagesCount, complexity]);

            useEffect(() => { generateData(); }, [generateData]);

            const downloadPdf = async () => {
                setIsGenerating(true);
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pages = containerRef.current.querySelectorAll('.a4-page');

                    for (let i = 0; i < pages.length; i++) {
                        const canvas = await html2canvas(pages[i], { scale: 3, useCORS: true });
                        const imgData = canvas.toDataURL('image/jpeg', 0.95);
                        if (i > 0) pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
                    }
                    pdf.save(`運筆練習卷_3x3_${new Date().toLocaleDateString()}.pdf`);
                } catch (error) {
                    alert('PDF 生成失敗，建議使用電腦瀏覽器列印功能。');
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-100 p-4 md:p-8">
                    {/* Controls */}
                    <div className="max-w-5xl mx-auto mb-8 no-print">
                        <div className="bg-white rounded-3xl shadow-xl p-8 border border-slate-200">
                            <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-8">
                                <div>
                                    <h1 className="text-2xl font-black text-slate-800 tracking-tight">運筆練習產生器 (上三下三版)</h1>
                                    <p className="text-slate-500 font-bold mt-1">設計者：鍾孟修 職能治療師</p>
                                </div>
                                <div className="flex flex-wrap gap-3">
                                    <button onClick={generateData} className="px-4 py-3 bg-slate-50 text-slate-700 font-black rounded-xl hover:bg-slate-100 transition-all">換一組題目</button>
                                    <button onClick={() => window.print()} className="px-5 py-3 bg-slate-800 text-white font-black rounded-xl hover:bg-black transition-all">電腦列印</button>
                                    <button onClick={downloadPdf} disabled={isGenerating} className="px-6 py-3 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 shadow-xl disabled:opacity-50">
                                        {isGenerating ? '生成中...' : '手機 PDF 下載'}
                                    </button>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-10 mt-8 pt-8 border-t-2 border-slate-50">
                                <div>
                                    <label className="block text-lg font-black text-slate-700 mb-4">生成份數 (A4 頁數)：{pagesCount}</label>
                                    <input type="range" min="1" max="10" value={pagesCount} onChange={(e) => setPagesCount(parseInt(e.target.value))} className="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                </div>
                                <div>
                                    <label className="block text-lg font-black text-slate-700 mb-4">題目難度：Lv.{complexity}</label>
                                    <input type="range" min="2" max="7" value={complexity} onChange={(e) => setComplexity(parseInt(e.target.value))} className="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Rendering */}
                    <div ref={containerRef} className="flex flex-col items-center gap-12 no-print:block">
                        {allPagesData.map((pageItems, pageIdx) => (
                            <div key={pageIdx} className="a4-page shadow-2xl overflow-hidden mb-8">
                                <div className="h-full p-[20mm] flex flex-col">
                                    <PageHeader />
                                    <div className="flex-1 flex flex-col justify-around py-4">
                                        <div className="grid grid-cols-3 gap-8">
                                            {pageItems.slice(0, 3).map((path, i) => <ExerciseCard key={i} path={path} />)}
                                        </div>
                                        <div className="grid grid-cols-3 gap-8">
                                            {pageItems.slice(3, 6).map((path, i) => <ExerciseCard key={i+3} path={path} />)}
                                        </div>
                                    </div>
                                    <FooterInfo />
                                    <div className="text-[10px] text-right text-slate-300 mt-2">第 {pageIdx + 1} 頁</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
